# Todos direitos autorais reservados pelo QOTA.

name: Qota Backend CI - Build & Test

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  backend-ci:
    runs-on: ubuntu-latest
    
    steps:
      # 1. Recuperação do código fonte
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. Configuração do ambiente de execução (Runtime)
      - name: Setup Node.js environment
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'package-lock.json' 

      # 3. Instalação de dependências nativas do SO
      # Necessário para o funcionamento correto do motor do SQLite em ambiente Linux/CI.
      - name: Install System Dependencies for Prisma
        run: sudo apt-get update && sudo apt-get install -y sqlite3 libsqlite3-dev

      # 4. Instalação de dependências do projeto
      # Utiliza 'npm ci' para uma instalação limpa e determinística baseada no lockfile.
      - name: Install Project Dependencies
        run: npm ci
        env:
          # Configuração de resiliência para ignorar falhas de checksum em caso de instabilidade nos servidores da Prisma.
          PRISMA_ENGINES_CHECKSUM_IGNORE_MISSING: "1"

      # 5. Geração dos artefatos do ORM
      # Compila o cliente Prisma baseado no schema atual.
      - name: Generate Prisma Client
        run: npx prisma generate
        env:
          PRISMA_ENGINES_CHECKSUM_IGNORE_MISSING: "1"

      # 6. Sincronização do Banco de Dados
      # Aplica migrações pendentes para garantir que o banco de teste esteja atualizado com a estrutura mais recente.
      - name: Run Prisma Migrations
        run: npx prisma migrate deploy
        env:
          # Injeção segura da string de conexão via GitHub Secrets.
          DATABASE_URL: ${{ secrets.DATABASE_URL_TEST }}
          PRISMA_ENGINES_CHECKSUM_IGNORE_MISSING: "1"

      # 7. Execução da Suíte de Testes Automatizados
      # Roda testes unitários e de integração para validar a integridade do sistema.
      - name: Run Automated Tests
        run: npm test
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL_TEST }}
          ACCESS_TOKEN_SECRET: ${{ secrets.ACCESS_TOKEN_SECRET_TEST }}
          REFRESH_TOKEN_SECRET: ${{ secrets.REFRESH_TOKEN_SECRET_TEST }}